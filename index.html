<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hari Bank</title>
  <style>
    /* Ваши стили */
    .dropdown-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .dropdown-container input {
      width: calc(100% - 40px); /* Учитываем ширину кнопки */
    }

    .dropdown-container button {
      position: absolute;
      right: 0;
      top: 0;
      width: 40px;
      height: 40px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 0 4px 4px 0;
    }

    .dropdown-container button:hover {
      background-color: #45a049;
    }

    #userDropdown {
      display: none;
      position: absolute;
      background-color: white;
      border: 1px solid #ddd;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      width: 100%;
    }

    #userDropdown div {
      padding: 10px;
      cursor: pointer;
    }

    #userDropdown div:hover {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>
  <div class="gradient-overlay"></div>
  <div class="leaf" style="left: 10%;"></div>
  <div class="leaf" style="left: 30%; animation-delay: 0.5s;"></div>
  <div class="leaf" style="left: 50%; animation-delay: 1s;"></div>
  <div class="leaf" style="left: 70%; animation-delay: 1.5s;"></div>
  <div class="leaf" style="left: 90%; animation-delay: 2s;"></div>

  <div class="container">
    <h1>Hari Bank</h1>
    <div id="registrationForm">
      <h2>Регистрация</h2>
      <div class="form-group">
        <label>Nick_Name:</label>
        <input type="text" id="nick" required>
      </div>
      <div class="form-group">
        <label>Пароль:</label>
        <input type="password" id="password" required>
      </div>
      <button onclick="register()">Зарегистрироваться</button>
      <button onclick="login()">Войти</button>
      <div id="message"></div>
    </div>
  </div>

  <div id="adminPanel" style="display: none;">
    <h1>Hari Bank</h1>
    <div>
      <h2>Панель администратора</h2>
      <div class="form-group">
        <label>Выберите пользователя:</label>
        <div class="dropdown-container">
          <input type="text" id="adminNick" placeholder="Нажмите, чтобы выбрать пользователя" readonly>
          <button onclick="toggleDropdown()">▼</button>
          <div id="userDropdown"></div>
        </div>
      </div>
      <div class="form-group">
        <label>Пароль:</label>
        <input type="text" id="adminPassword" readonly>
      </div>
      <div class="form-group">
        <label>Баллы:</label>
        <input type="number" id="adminPoints" value="0">
      </div>
      <div class="form-group">
        <label>Харикоины:</label>
        <input type="number" id="adminHaricoins" value="0">
      </div>
      <button onclick="updateUserData()">Обновить данные</button>
      <button onclick="deleteUser()" style="background-color: #ff4444;">Удалить пользователя</button>
      <button onclick="logout()">Выйти</button>
    </div>
  </div>

  <script>
    const spreadsheetId = "1QYZeJonqTuGASyfIQN7BoV1Sls4zGChQCy_gHRh-9ck"; // Замени на свой ID
    const apiKey = "AIzaSyAYXP4fq59VAGpyLjmKatydhBussnQF86c"; // Замени на свой API-ключ

    // Функция для чтения данных из таблицы
    async function readData() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Sheet1?key=${apiKey}`;
      console.log("Запрос к таблице:", url);

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Ошибка HTTP: ${response.status}`);
        }
        const data = await response.json();
        console.log("Ответ от API:", data);

        if (!data.values) {
          console.error("Таблица пуста или данные не найдены.");
          return [];
        }
        return data.values;
      } catch (error) {
        console.error("Ошибка при чтении данных:", error);
        showMessage("Ошибка при загрузке данных!", "red");
        return [];
      }
    }

    // Функция для записи данных в таблицу
    async function writeData(data) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Sheet1:append?valueInputOption=RAW&key=${apiKey}`;
      console.log("Запрос на запись:", url, data);

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            values: [data],
          }),
        });

        const result = await response.json();
        console.log("Результат записи:", result);
        return result;
      } catch (error) {
        console.error("Ошибка при записи данных:", error);
        showMessage("Ошибка при записи данных!", "red");
      }
    }

    // Функция для регистрации
    async function register() {
      const nick = document.getElementById("nick").value.trim();
      const password = document.getElementById("password").value.trim();

      console.log("Регистрация:", nick, password);

      try {
        const users = await readData();
        const userExists = users.some(user => user[0] === nick);

        if (userExists) {
          showMessage("Пользователь с таким именем уже существует!", "red");
          return;
        }

        const newUser = [nick, password, false, 0, 0]; // Формат строки
        await writeData(newUser);
        showMessage("Регистрация прошла успешно!", "green");

        document.getElementById("nick").value = "";
        document.getElementById("password").value = "";
      } catch (error) {
        console.error("Ошибка при регистрации:", error);
        showMessage("Ошибка при регистрации!", "red");
      }
    }

    // Функция для входа
    async function login() {
      const nick = document.getElementById("nick").value.trim();
      const password = document.getElementById("password").value.trim();

      console.log("Вход:", nick, password);

      try {
        const users = await readData();
        console.log("Данные пользователей:", users); // Отладочное сообщение

        if (!users || users.length === 0) {
          showMessage("Ошибка: данные не загружены!", "red");
          return;
        }

        const user = users.find(user => user[0] === nick && user[1] === password);

        if (user) {
          console.log("Найден пользователь:", user); // Отладочное сообщение

          // Проверка на администратора (учитываем строку "TRUE" и булево значение true)
          if (user[2] === true || user[2].toUpperCase() === "TRUE") {
            console.log("Пользователь является администратором"); // Отладочное сообщение
            showAdminPanel(users);
          } else {
            console.log("Пользователь не является администратором"); // Отладочное сообщение
            showProfile(user);
          }
        } else {
          showMessage("Неверный логин или пароль!", "red");
        }
      } catch (error) {
        console.error("Ошибка при входе:", error);
        showMessage("Ошибка при входе!", "red");
      }
    }

    // Функция для отображения профиля
    function showProfile(user) {
      const container = document.querySelector(".container");
      container.innerHTML = `
        <h1>Hari Bank</h1>
        <div id="profile">
          <h2>Профиль</h2>
          <p>Никнейм: <span id="profileNick">${user[0]}</span></p>
          <p>Баллы: <span id="profilePoints">${user[3]}</span></p>
          <p>Харикоины: <span id="profileHaricoins">${user[4]}</span></p>
          <button onclick="logout()">Выйти</button>
        </div>
      `;
    }

    // Функция для отображения панели администратора
    function showAdminPanel(users) {
      document.getElementById("registrationForm").style.display = "none";
      document.getElementById("adminPanel").style.display = "block";

      const userDropdown = document.getElementById("userDropdown");

      // Очищаем выпадающий список
      userDropdown.innerHTML = "";

      console.log("Пользователи из таблицы:", users); // Отладочное сообщение

      // Добавляем пользователей в выпадающий список
      users.forEach((user, index) => {
        if (user[2] === "false" || user[2] === false) { // Исключаем администратора
          const userDiv = document.createElement("div");
          userDiv.textContent = user[0]; // Никнейм
          userDiv.onclick = () => {
            document.getElementById("adminNick").value = user[0];
            document.getElementById("adminPassword").value = user[1];
            document.getElementById("adminPoints").value = user[3];
            document.getElementById("adminHaricoins").value = user[4];
            userDropdown.style.display = "none"; // Скрываем список после выбора
          };
          userDropdown.appendChild(userDiv);
        }
      });
    }

    // Функция для переключения выпадающего списка
    function toggleDropdown() {
      const userDropdown = document.getElementById("userDropdown");
      if (userDropdown.style.display === "block") {
        userDropdown.style.display = "none";
      } else {
        userDropdown.style.display = "block";
      }
    }

    // Функция для обновления данных пользователя
    async function updateUserData() {
      const nick = document.getElementById("adminNick").value;
      const points = parseInt(document.getElementById("adminPoints").value);
      const haricoins = parseInt(document.getElementById("adminHaricoins").value);

      const users = await readData();
      const userIndex = users.findIndex(user => user[0] === nick);

      if (userIndex !== -1) {
        const updatedUser = [
          users[userIndex][0], // Никнейм
          users[userIndex][1], // Пароль
          users[userIndex][2], // Администратор
          points, // Баллы
          haricoins, // Харикоины
        ];

        const result = await updateData(userIndex + 1, updatedUser); // Обновляем данные в таблице
        if (result.error) {
          showMessage("Ошибка при обновлении данных!", "red");
        } else {
          showMessage("Данные пользователя обновлены!", "green");
        }
      } else {
        showMessage("Пользователь не найден!", "red");
      }
    }

    // Функция для отображения сообщений
    function showMessage(message, color) {
      const messageElement = document.getElementById("message");
      if (messageElement) {
        messageElement.innerText = message;
        messageElement.style.color = color;
      } else {
        console.error("Элемент для сообщений не найден!");
      }
    }

    // Функция для выхода
    function logout() {
      document.getElementById("adminPanel").style.display = "none";
      document.getElementById("registrationForm").style.display = "block";
    }
  </script>
</body>
</html>
